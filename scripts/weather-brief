#!/usr/bin/env node

const https = require('https');

const USAGE = `
ğŸŒ¤ï¸  Weather Briefing Tool

Usage: weather-brief [location]

Examples:
  weather-brief                    # Default: Chicago
  weather-brief "Austin, TX"       # Specific location  
  weather-brief --help            # Show this help

Outputs a clean, formatted weather briefing ready for messaging.
`;

function showHelp() {
    console.log(USAGE);
    process.exit(0);
}

function fetchWeather(location) {
    return new Promise((resolve, reject) => {
        // Use wttr.in API with format parameters for clean output
        const url = `https://wttr.in/${encodeURIComponent(location)}?format=j1`;
        
        https.get(url, (res) => {
            let data = '';
            res.on('data', (chunk) => data += chunk);
            res.on('end', () => {
                try {
                    resolve(JSON.parse(data));
                } catch (e) {
                    reject(new Error('Invalid weather data received'));
                }
            });
        }).on('error', reject);
    });
}

function getWeatherEmoji(code) {
    const weatherCodes = {
        113: 'â˜€ï¸', // Sunny
        116: 'â›…', // Partly cloudy
        119: 'â˜ï¸', // Cloudy
        122: 'â˜ï¸', // Overcast
        143: 'ğŸŒ«ï¸', // Mist
        176: 'ğŸŒ¦ï¸', // Patchy rain possible
        179: 'ğŸŒ¨ï¸', // Patchy snow possible
        182: 'ğŸŒ¨ï¸', // Patchy sleet possible
        185: 'ğŸŒ¨ï¸', // Patchy freezing drizzle possible
        200: 'â›ˆï¸', // Thundery outbreaks possible
        227: 'ğŸŒ¨ï¸', // Blowing snow
        230: 'â„ï¸', // Blizzard
        248: 'ğŸŒ«ï¸', // Fog
        260: 'ğŸŒ«ï¸', // Freezing fog
        263: 'ğŸŒ¦ï¸', // Patchy light drizzle
        266: 'ğŸŒ§ï¸', // Light drizzle
        281: 'ğŸ§Š', // Freezing drizzle
        284: 'ğŸ§Š', // Heavy freezing drizzle
        293: 'ğŸŒ¦ï¸', // Patchy light rain
        296: 'ğŸŒ§ï¸', // Light rain
        299: 'ğŸŒ§ï¸', // Moderate rain at times
        302: 'ğŸŒ§ï¸', // Moderate rain
        305: 'ğŸŒ§ï¸', // Heavy rain at times
        308: 'ğŸŒ§ï¸', // Heavy rain
        311: 'ğŸ§Š', // Light freezing rain
        314: 'ğŸ§Š', // Moderate or heavy freezing rain
        317: 'ğŸŒ¨ï¸', // Light sleet
        320: 'ğŸŒ¨ï¸', // Moderate or heavy sleet
        323: 'ğŸŒ¨ï¸', // Patchy light snow
        326: 'â„ï¸', // Light snow
        329: 'â„ï¸', // Patchy moderate snow
        332: 'â„ï¸', // Moderate snow
        335: 'â„ï¸', // Patchy heavy snow
        338: 'â„ï¸', // Heavy snow
        350: 'ğŸŒ¨ï¸', // Ice pellets
        353: 'ğŸŒ¦ï¸', // Light rain shower
        356: 'ğŸŒ§ï¸', // Moderate or heavy rain shower
        359: 'ğŸŒ§ï¸', // Torrential rain shower
        362: 'ğŸŒ¨ï¸', // Light sleet showers
        365: 'ğŸŒ¨ï¸', // Moderate or heavy sleet showers
        368: 'â„ï¸', // Light snow showers
        371: 'â„ï¸', // Moderate or heavy snow showers
        374: 'ğŸŒ¨ï¸', // Light showers of ice pellets
        377: 'ğŸŒ¨ï¸', // Moderate or heavy showers of ice pellets
        386: 'â›ˆï¸', // Patchy light rain with thunder
        389: 'â›ˆï¸', // Moderate or heavy rain with thunder
        392: 'â›ˆï¸', // Patchy light snow with thunder
        395: 'â›ˆï¸'  // Moderate or heavy snow with thunder
    };
    return weatherCodes[code] || 'ğŸŒ¤ï¸';
}

function formatTemperature(temp, unit = 'F') {
    return unit === 'F' ? `${temp}Â°F` : `${temp}Â°C`;
}

function formatTime(timeString) {
    const time = new Date(`1970-01-01 ${timeString}`);
    return time.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
    });
}

function formatWeatherBriefing(data, location) {
    const current = data.current_condition[0];
    const today = data.weather[0];
    const tomorrow = data.weather[1];
    
    let briefing = `ğŸŒ¤ï¸ **Weather Briefing for ${data.nearest_area[0].areaName[0].value}**\n\n`;
    
    // Current conditions
    const currentEmoji = getWeatherEmoji(parseInt(current.weatherCode));
    briefing += `**Right Now** ${currentEmoji}\n`;
    briefing += `${formatTemperature(current.temp_F)}Â° â€¢ Feels like ${formatTemperature(current.FeelsLikeF)}Â°\n`;
    briefing += `${current.weatherDesc[0].value}\n`;
    briefing += `ğŸ’¨ ${current.windspeedMiles}mph ${current.winddir16Point} â€¢ ğŸ’§ ${current.humidity}%\n\n`;
    
    // Next 6 hours
    briefing += `**Next 6 Hours**\n`;
    const currentHour = new Date().getHours();
    const hourlyData = today.hourly;
    
    for (let i = 0; i < Math.min(6, hourlyData.length); i++) {
        const hour = hourlyData[i];
        const hourTime = parseInt(hour.time) / 100;
        if (hourTime >= currentHour || i === 0) {
            const emoji = getWeatherEmoji(parseInt(hour.weatherCode));
            const time = formatTime(hour.time.padStart(4, '0').substring(0,2) + ':' + hour.time.padStart(4, '0').substring(2));
            briefing += `${time}: ${formatTemperature(hour.tempF)}Â° ${emoji} ${hour.chanceOfRain}% rain\n`;
        }
    }
    
    // Today's summary
    briefing += `\n**Today**\n`;
    briefing += `ğŸŒ… High: ${formatTemperature(today.maxtempF)}Â° â€¢ ğŸŒ™ Low: ${formatTemperature(today.mintempF)}Â°\n`;
    briefing += `â˜” Rain: ${today.hourly[0].chanceOfRain}% chance\n`;
    briefing += `ğŸŒ… Sunrise: ${today.astronomy[0].sunrise} â€¢ ğŸŒ‡ Sunset: ${today.astronomy[0].sunset}\n`;
    
    if (tomorrow) {
        briefing += `\n**Tomorrow** ${getWeatherEmoji(parseInt(tomorrow.hourly[4].weatherCode))}\n`;
        briefing += `High: ${formatTemperature(tomorrow.maxtempF)}Â° â€¢ Low: ${formatTemperature(tomorrow.mintempF)}Â°\n`;
        briefing += `${tomorrow.hourly[4].weatherDesc[0].value}\n`;
    }
    
    return briefing;
}

async function main() {
    const args = process.argv.slice(2);
    
    if (args.includes('--help') || args.includes('-h')) {
        showHelp();
    }
    
    const location = args[0] || 'Chicago';
    
    try {
        console.log('ğŸŒ¤ï¸ Fetching weather data...');
        const weatherData = await fetchWeather(location);
        
        if (weatherData.error) {
            console.error(`âŒ Error: ${weatherData.error[0].msg}`);
            process.exit(1);
        }
        
        const briefing = formatWeatherBriefing(weatherData, location);
        console.clear();
        console.log(briefing);
        
    } catch (error) {
        console.error(`âŒ Failed to fetch weather: ${error.message}`);
        process.exit(1);
    }
}

if (require.main === module) {
    main();
}